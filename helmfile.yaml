releases:
  - name: nginx-ingress
    namespace: kube-system
    chart: stable/nginx-ingress
    values:
      # https://github.com/kubernetes/charts/tree/master/stable/nginx-ingress
      - rbac:
          create: true
        controller:
          replicaCount: 2
          resources:
            limits:
              memory: 128Mi
            requests:
              memory: 128Mi
          service:
            type: NodePort
            nodePorts:
              http: 30080
          stats:
            enabled: true
          # https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/configmap.md
          config:
            proxy-read-timeout: "180"
            proxy-send-timeout: "180"
            # Large request header (e.g. OIDC proxy)
            proxy-buffer-size: "64k"
            # Large request body (e.g. file upload)
            proxy-body-size: "512m"
            server-tokens: "false"
        defaultBackend:
          replicaCount: 2
          resources:
            limits:
              memory: 16Mi
            requests:
              memory: 16Mi

  - name: efs-provisioner
    namespace: kube-system
    chart: stable/efs-provisioner
    values:
      # https://github.com/helm/charts/tree/master/stable/efs-provisioner
      - efsProvisioner:
          efsFileSystemId: {{ requiredEnv "efs_provisoner_file_system_id" }}
          awsRegion: {{ requiredEnv "AWS_DEFAULT_REGION" }}
          path: /
          storageClass:
            name: efs
            isDefault: true

  - name: fluent-bit
    namespace: kube-system
    chart: stable/fluent-bit
    values:
      # https://github.com/helm/charts/tree/master/stable/fluent-bit
      - backend:
          type: es
          es:
            host: {{ requiredEnv "es_logs_endpoint" }}
            port: 443
            tls: "on"
        resources:
          limits:
            memory: 64Mi
          requests:
            cpu: 0
            memory: 64Mi

  - name: kibana
    namespace: kube-system
    chart: stable/kibana
    values:
      # https://github.com/helm/charts/tree/master/stable/kibana
      - env:
          ELASTICSEARCH_URL: https://{{ requiredEnv "es_logs_endpoint" }}:443
        image:
          tag: 6.2.4
        # TODO: ingress
        resources:
          limits:
            memory: 256Mi
          requests:
            memory: 256Mi
